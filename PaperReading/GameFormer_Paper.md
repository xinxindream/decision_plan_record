# GameFormer: Game-theoretic Modeling and Learning of Transformer-based Interactive Prediction and Planning for Autonomous Driving
Game-theoretic : 博弈论
interactive: 交互

## Abstract
### 1、简单翻译
1. 现实世界交通环境复杂，自动驾驶的运行需要准确的预测交通参与者之间的交互行为。本文提出了**层级博弈论**来解决交互预测问题并提出GameFormer来实现它。
2. 该模型包含一个**transformer编码器**,还有一个**层级transformer解码器**结构
3. 对于层级解码器，每一层的解码器都会**利用前一层的预测结果**，同时也会**共享环境上下文**，从而来**迭代**优化交互过程
4. 此外，我们还提出一个**学习过程**，可以**调节当前**层交通参与者来响应前一层的其他交通参与者
5. 接下来就是说我们的模型很牛

### 2、注意点
1. transformer编码器怎么安放的
2. 层级transformer解码器是如何体现层级的
3. 环境上下文如何共享
4. 利用前一层预测结果，说明前一层的输出是下一层的输入
5. 论文中的level，我翻译为层级，因为有级别之分

## 1. Introduction
&emsp;&emsp;准确预测周围交通参与者的未来行为并做出安全且与社会兼容的决策对于现代自动驾驶至关重要。然而，由于道路结构、交通规范和道路使用者之间的**相互作用**所产生的复杂性，这项任务极具挑战性。近年来，基于深度神经网络的方法在预测精度和可扩展性方面取得了显着进步。特别是，transformer在运动预测方面获得了突出的地位，因为它们在处理来自驾驶场景的异构信息方面具有灵活性和有效性，并且能够捕获场景元素之间的相互关系。  
&emsp;&emsp;尽管现有的预测模型在编码驾驶场景和通过交通参与者的历史轨迹进行表示交互方面取得了成功，但它们通常无法明确地建模agents的未来交互以及他们与自动驾驶车辆（AV）的交互。这种限制导致自动驾驶汽车的规划模块对预测结果做出被动反应。然而，在并道、变道、无保护左转等危急情况下，自动驾驶汽车需要主动与其他智能体协调。因此，**联合预测和规划**对于实现更具交互性和人性化的决策是必要的。为了解决这个问题，一种典型的方法是最近提出的**条件预测模型**，它利用自动驾驶汽车的内部计划来预测其他agents对自动驾驶汽车的响应。尽管条件预测模型缓解了交互问题，但这种**单向交互**仍然忽略了自动驾驶汽车和其他道路使用者之间的动态相互影响。从**博弈论**的角度来看，当前的预测/规划模型可以被视为**领导者-追随者**博弈，同时agents的交互水平**有限**。  
&emsp;&emsp;在本研究中，我们利用分层博弈论框架（k级博弈论） 来建模各种代理之间的交互，并引入一种名为 GameFormer 的新颖模型，它是基于 Transformer 的预测模型。源于认知科学的见解，level-k博弈论提供了一种结构化方法来建模代理之间的交互。该理论的核心引入了由 k 表示推理深度的层次结构。0 级agent独立行动，不考虑其他智能体可能的行动。往上一层，1 级的agent通过假设其他agents为 0 级来考虑交互，并相应地预测它们的操作。这个过程一直迭代，k 级agent会预测其他agents的行为，通过假设他们是（k−1）级，并根据这些预测做出响应。通过考虑agents的推理水平和显式交互，我们的模型符合 k 级博弈论。
&emsp;&emsp;如图 1 所示，我们最初使用 **Transformer 编码器**将**驾驶场景编码为背景信息**，包括**矢量化地图和观察到的agents状态**。在未来的解码阶段，我们遵循k级博弈论来设计结构。具体来说，我们设置了一系列 Transformer 解码器来实现 k 级推理。0 级解码器仅使用初始模态的查询矩阵和编码场景上下文作为键和值来预测agents的多模态未来轨迹。然后，在每次迭代 k 时，k 级解码器将（k−1）级解码器的预测轨迹以及背景信息作为输入，以预测当前级别的agents的轨迹。此外，我们设计了一个学习过程，可以调节agents的轨迹，来响应前一级其他agents的轨迹，同时也保持接近人类驾驶数据。  
&emsp;&emsp;本文的主要贡献总结如下：  
&emsp;&emsp;&emsp;&emsp;1. 我们提出 GameFormer，一个基于 Transformer 的交互式预测和规划框架。该模型采用**层级解码结构**来捕获agents之间的交互，迭代地细化预测，并基于 k 级博弈形式进行训练。  
&emsp;&emsp;&emsp;&emsp;2. 我们在 Waymo 交互预测基准上展示了 GameFormer 模型最先进的预测性能。  
&emsp;&emsp;&emsp;&emsp;3. 我们使用 Waymo 开放运动数据集和 nuPlan 规划基准来验证 GameFormer 框架在开环驾驶场景和闭环模拟中的规划性能。

tips:
1. 只有解码器有层级结构
2. 解码器的设计还遵循k级博弈论
3. k级解码器的输入有很多：前一级的输出，场景上下文（来源于编码器）

## 2. Related Work
### 2.1. Motion Prediction for Autonomous Driving
&emsp;&emsp;神经网络模型通过编码上下文场景信息在运动预测方面表现出了显着的有效性。早期研究利用LSTM  对智能体过去的状态进行编码，并利用CNN处理场景的光栅化图像。为了对代理之间的交互进行建模，GNN被广泛用于通过场景或交互图来表示代理交互。最近，由于其紧凑的模型描述和卓越的性能，用于运动预测的统一Transformer编码器-解码器结构越来越受欢迎，例如 SceneTransformer和 WayFormer。然而，大多数基于 Transformer 的预测模型都专注于编码部分，而较少重视解码部分。Motion Transformer通过提出一个精心设计的解码阶段来解决这一限制，该解码阶段利用迭代局部运动细化来提高预测精度。受迭代细化和分层博弈论的启发，我们的方法引入了一种新颖的基于 Transformer 的解码器用于交互预测，提供了一种明确的方法来建模代理之间的交互。
&emsp;&emsp;关于预测模型在规划任务中的使用，许多工作都集中在多agents联合运动预测框架上，该框架能够有效且一致地预测多模态多智能体轨迹。现有运动预测模型的一个固有问题是**它们经常忽略自动驾驶汽车动作的影响**，导致它们不适合下游规划任务。为了解决这个问题，通过将 AV 规划信息集成到预测过程中，提出了几种条件多智能体运动预测模型。然而，这些模型仍然表现出单向交互作用，忽略了代理之间的相互影响。相比之下，我们的方法旨在共同预测周围智能体的未来轨迹，并通过迭代交互建模促进 AV 规划。

### 2.2. Learning for Decision-making
&emsp;&emsp;运动预测模块的主要目标是使规划模块能够做出安全且智能的决策。这可以通过使用离线学习方法来实现，该方法可以从大规模驾驶数据集中学习决策策略。模仿学习是最流行的方法，旨在学习可以复制专家行为的驾驶策略。**离线强化学习**也引起了人们的兴趣，因为它结合了强化学习和收集的大型数据集的优点。然而，直接的策略学习缺乏可解释性和安全保证，并且经常遭受分配变化。相比之下，使用学习的**运动预测模型**进行**规划**被认为更具可解释性和鲁棒性，使其成为自动驾驶更理想的方式。我们提出的方法旨在增强预测模型的能力，从而提高交互式决策性能。


tips:
1. 我一直以为的就是用数据让汽车去学习轨迹，从而在未来预测时，自身去模仿相应轨迹解决问题，好像进入了误区

## 3. GameFormer
&emsp;&emsp;本节介绍我们的交互式预测和规划框架，称为 GameFormer，它采用 Transformer 编码器-解码器架构。在接下来的3.1中，我们首先定义问题并讨论指导模型设计和学习过程的 k 级博弈论。然后，我们在第 3.2 中描述模型的编码器组件，该组件对场景上下文进行编码。在3.3节中将介绍3.2中的解码器组件所结合的新颖的交互建模概念。最后，我们在第3.4节中介绍解释不同推理级别之间相互作用的学习过程。

### 3.1. Game-theoretic Formulation
&emsp;&emsp;我们考虑一个驾驶场景，里面有 N 个agents（包含自车），其中我们用$A_0$表示自车，自车t=0时刻时周围的agents用$A_1, A_2, ......A_{n-1}$表示。给定过去一个时间范围$T_h$内的agents（包含自车）状态集合$S= \left \{  s_i^{-T_h:0} \right \}$。  
> $S是一个集合，每一个元素s_i又是一个集合$  
> $每个s_i包含了过去T_h范围内的状态信息$

还提供了地图信息 M，包括了红绿灯以及道路点（中心线的点，一些标志性道路标志的边缘点），这些数据给出来的目标是联合它们来预测自车以及周围的agents在未来的一段时间$T_f$内的轨迹，我们用集合$Y_{1:N-1}^{1:T_f}$来表示，自车的轨迹用$Y_0^{1:T_f}$来表示。
> $Y_{1:N-1}^{1:T_f}中的下标表示自车周围A_1, A_2, ......A_n$  
> $Y_{1:N-1}^{1:T_f}中的上标表示从1开始到未来T_f时刻$

为了捕获预测过程中的不确定性，所以结果通常是自车和邻近agents的**多模态**未来轨迹，我们用一个集合表示$Y_i^{1:T_f} = \{ y_j^{1:T_f}, p_j | j = 1:M \}$
> $y_j^{1:T_f} 是未来状态预测序列$
> $p_j 是对应y_j^{1:T_f}的置信度$
> $M是模态数量$

tips:
1. 这个多模态，我觉得可能可以理解为多种速度，多种加速度等汽车自身的状态数值

&emsp;&emsp;我们利用 k 级博弈论以迭代方式对agent交互进行建模。我们并不是简单地预测一组单组轨迹，而是预测一种轨迹层次结构来建立认知交互过程的模型。在每个推理级别，除了第0级之外的每一个级别的解码器，都会将前一级别的预测结果作为输入，这可以有效地使它们成为场景的一部分，并估计当前级别中的agents对前面级别的其他agents的响应。我们将第i个agent在k推理层上预测的多模态轨迹（本质上是一个高斯混合模型）表示为$\pi_i^{(k)}$，$\pi_i^{(k)}$也可以看作是该agent的一种策略。$\pi_i^{(k)}$以第（k-1）推理层中除了第i个agent以外的所有agents的策略$(\pi_{\neg i}^{(k-1)})$为条件的。举个栗子：自车在第2推理层的策略$\pi_0^{(2)}$会考虑第1个推理层中所有邻近agents的策略$\pi_{1:N-1}^{(1)}$